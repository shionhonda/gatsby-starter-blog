---
title: 書評『データ指向アプリケーションデザイン』
date: "2023-04-08T22:12:03.284Z"
description: "『データ指向アプリケーションデザイン』のまとめと感想です。"
featuredImage: book_review_kleppmann/ogp.jpg
tags: ["ja", "book"]
---

## はじめに

『データ指向アプリケーションデザイン』（Martin Kleppmann　著、斉藤 太郎　監訳、玉川 竜司　訳、O’Reilly Japan、2019年）を読んだので、まとめと感想を書きます。

<iframe sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin" style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=hippocampus09-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4873118700&linkId=9c1d7bb09097c6ff19ab53dd2332e3bf"></iframe>

本書は

データ指向アプリケーションデザインとは、

## 総評

具体的な名前が多数登場する（本記事では省略しがち）

## 内容のまとめ

### 第I部 データシステムの基礎

データ指向アプリケーションの設計を支える基本的な概念について述べる。

#### 1章：信頼性、スケーラビリティ、メンテナンス性に優れたアプリケーション

今日の多くのアプリケーションは、**演算指向**ではなく**データ指向**であると言えます。すなわち、制約条件がCPUではなくデータ（量、複雑さ、変化する速度）となることがほとんどです。こういったアプリケーションでは、**データベース**、**キャッシュ**、**検索インデックス**、**ストリーム処理**、**バッチ処理**などの機能が必要になります。これらの機能を抽象化するツールまたはツール群（**データシステム**）は数多くありますが、アプリケーション開発においてそれらの仕組みや性質について知っておくことは重要です。

まず、本書の全体を通して必要となる基本的な概念である、**信頼性**、**スケーラビリティ**、**メンテナンス性**を導入します。

信頼性とは、何か問題が生じたとしても正しく動作し続けることです。ここでいう問題には、以下のような種類があります。

- ハードウェア障害：ディスクのクラッシュ、停電、ネットワークの切断など。こういった事象は多数のマシンが関わる大規模なシステムでは日常的に発生し、対策として冗長化が行われます。
- ソフトウェアのエラー：単なるバグ、プロセスの暴走、依存先サービスの障害など。これらを完全に解決する方法はなく、テストやモニタリングなどを徹底することで対策することしかできません。
- ヒューマンエラー：設定ミスなど。障害の最大の原因とも言われています。対策としては優れたインターフェイスやサンドボックス環境の用意などがあります。

スケーラビリティとは、負荷の増大に対してシステムが対応できる能力のことです。能力を測る指標には**スループット**と**レスポンスタイム**などがあり、99.9パーセンタイルなどの統計量が使われます。

スケーラビリティについて議論するためにはまず、負荷が何に依存しているかを知ることが大事です。Twitterを例に考えてみましょう。負荷は、タイムラインの読み込みとツイートの書き込みのどちらに強く依存しているのでしょうか？その度合いは、ユーザのフォロー数やフォロワー数によってどのように変わるのでしょうか？これらの要素がどうなっているかによって、最適なシステム設計が変わってきます。

なお、パフォーマンスを上げる一般的な方法としては、**スケールアップ**（**垂直スケーリング**；マシンを強力なものにする）と**スケールアウト**（**水平スケーリング**；マシンの数を増やす）があります。

メンテナンス性とは、運用時のコストの低さのことです。これは、システムの単純性や変更容易性によって達成されます。

2章：データモデルとクエリ言語

次に、アプリケーションにおいてデータを表現する存在である**データモデル**のについて見ていきます。主なデータモデルとしては、**リレーショナルモデル**、**ドキュメントモデル**、**グラフモデル**があります。

リレーショナルモデルは、データをリレーション（表のこと）で表現します。それぞれのリレーションはタプル（行のこと）の集合です。リレーショナルデータベース（relational database; **RDB**）は、1960年代にビジネスデータの処理（**トランザクション処理**や**バッチ処理**）を起源として発展しました。その後、汎用性の高さからユースケースが拡大し、今でも現役で使われています。

2010年代になると、さらなるスケーラビリティや柔軟性を志向する**NoSQL**が登場しました。そのうちのドキュメントモデルという類型はJSONのような形式でデータを表現します。ドキュメントモデルには、オブジェクト指向言語における**インピーダンスミスマッチ**（オブジェクトとデータの間の変換処理）が小さいという利点がある一方、ドキュメント間の関係を表現しづらいという欠点があります。多くのデータベースでリレーショナルとドキュメントのハイブリッドモデルを採用する動きがあります。

データ間で多対多の関係が一般的な場合には、グラフモデルが適しています。例えば、Webグラフを表現するならば、Webページを頂点、ページ間のリンクを辺で表すことができます。Neo4jはグラフデータベースの代表例です。

データを操作するクエリ言語には、SQLのように**宣言的**なものと、IMSやCODASYLのように**命令的**なものがあります。宣言的言語では操作方法ではなく操作完了後の理想状態を指定するので、システム側で計算処理の最適化ができます（例：BigQuery）。

3章：ストレージと抽出

データベースを外から見てきたので、次はデータベースの内側を見ていきます。この内部処理は通常抽象化されていますが、様々なストレージエンジンの中から適切なものを選ぶ際に理解しておく必要があります。特に、トランザクション用のエンジンと分析用のエンジンでは性質が大きく異なります。

探索はインデックスによって高速化できるが、書き込みを低速にするというトレードオフがある。
最も簡単なインデックスはハッシュインデックス。ディスク領域がいっぱいになったら、ログをセグメントに分割し、一定サイズ以上になったセグメントはクローズしてしまうこと。各セグメントについて各キーの重複を消す処理をコンパクションと呼ぶ。コンパクションで小さくなったセグメントをマージすることもできる。書き込みを追記のみとすることで高速に実行でき、並行処理やクラッシュリカバリが単純化できる。クラッシュリカバリは、インメモリのハッシュマップを復元するためにディスク上のスナップショットを読み出す処理。一方で、メモリ制約と範囲検索ができないという制約は存在する。
キーをソートしておくと、範囲の検索が可能になる。これをソート済み文字列テーブル（SSTable）と呼ぶ。ソート済みキーの管理はインメモリであればred-blackツリーやAVLツリーといった木構造を利用できる。インメモリツリーはmemtableとも呼ばれる。クラッシュリカバリにはLog-Structured Merge Tree(LSMツリー)と呼ばれる構造を使う。Luceneの単語辞書もこの構造。Bitcask, STTable, LSMTree, LevelDB, CAssandra, HBase, Lucene.
現在でもっとも広く使われているのはB（Balanced）ツリー。1970年以来、RDBの標準的な実装であり続けている。Bツリーはデータベースを固定サイズのブロック（ページ）に分割する。各ブロックは一度に読み書きできるサイズ。Balancedというのは、N個のキーを深さO(log n)の木で保存するということ。Bツリーの書き込みは、最終行への追記ではなく該当ブロックの上書きで行う。ここの信頼性を高めるために、write-aheadログ（WAL）という追記のみのログファイルをもたせる。キーを短縮してメモリを節約するものをB+ツリーと呼ぶ。
比較すると、LSMツリーは書き込みが速く、Bツリーは読み取りが速い。
最近はMemcachedやVoltDBやRedisなどのインメモリデータベースも発展してきている。インメモリデータベースは読み取り（キャッシュによって既に高速化されている）よりも書き取りの高速化メリットが大きい。
DBとのやり取りにはトランザクション処理（OLTP）と分析処理（OLAP）がある。SQLはどちらに対しても対応できる柔軟性を持つが、データベースは分離したほうが都合の良いことが多く、後者はデータウェアハウスとして発展した。
データウェアハウスはリレーショナルなデータモデルを扱うことが多い。スタースキーマの一種として、カラムをいくつかのカテゴリに分割したスノーフレークスキーマというものがある。こちらのほうが分析においては使いやすいことがある。
また、分析においては列指向ストレージのほうが効率が良い。よく取り出される行集合について統計量をキャッシュしておく「データキューブ」と呼ばれるマテリアライズドビューがある。